generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String?
  name                String
  role                UserRole
  phone               String?
  clinicId            String?
  hmoId               String?
  twoFactorSecret     String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  accounts            Account[]
  createdAppointments Appointment[]        @relation("CreatedAppointments")
  appointments        Appointment[]        @relation("DoctorAppointments")
  auditLogs           AuditLog[]
  availability        DoctorAvailability[]
  medicalRecords      MedicalRecord[]
  notifications       Notification[]
  clinicCode  String?  // Add this field
  patient             Patient?
  prescriptions       Prescription[]
  sessions            Session[]
  clinic              Clinic?              @relation(fields: [clinicId], references: [id])
  hmo                 HMO?                 @relation(fields: [hmoId], references: [id])
}

model Clinic {
  id              String               @id @default(cuid())
  name            String
  address         String
  phone           String
  email           String
  description     String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  appointments    Appointment[]
  hmos            ClinicHMO[]
  settings        ClinicSetting[]
  availability    DoctorAvailability[]
  emergencyAlerts EmergencyAlert[]
  patients        Patient[]
  users           User[]
}

model HMO {
  id           String      @id @default(cuid())
  name         String
  contactEmail String
  contactPhone String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  clinics      ClinicHMO[]
  patients     Patient[]
  users        User[]
}

model ClinicHMO {
  id        String   @id @default(cuid())
  clinicId  String
  hmoId     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clinic    Clinic   @relation(fields: [clinicId], references: [id])
  hmo       HMO      @relation(fields: [hmoId], references: [id])
}

model Patient {
  id               String           @id @default(cuid())
  firstName        String
  lastName         String
  dateOfBirth      DateTime
  gender           Gender
  phone            String
  email            String?
  address          String?
  emergencyContact String?
  bloodType        String?
  allergies        String?
  hmoId            String?
  clinicId         String
  userId           String?          @unique
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  appointments     Appointment[]
  bills            Billing[]
  emergencyAlerts  EmergencyAlert[]
  medicalRecords   MedicalRecord[]
  clinic           Clinic           @relation(fields: [clinicId], references: [id])
  hmo              HMO?             @relation(fields: [hmoId], references: [id])
  user             User?            @relation(fields: [userId], references: [id])
  prescriptions    Prescription[]
}

model Appointment {
  id           String                @id @default(cuid())
  patientId    String
  doctorId     String
  clinicId     String
  scheduledFor DateTime
  duration     Int                   @default(30)
  status       AppointmentStatus     @default(SCHEDULED)
  reason       String?
  notes        String?
  createdById  String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  clinic       Clinic                @relation(fields: [clinicId], references: [id])
  createdBy    User?                 @relation("CreatedAppointments", fields: [createdById], references: [id])
  doctor       User                  @relation("DoctorAppointments", fields: [doctorId], references: [id])
  patient      Patient               @relation(fields: [patientId], references: [id])
  reminders    AppointmentReminder[]
  billing      Billing?
}

model AppointmentReminder {
  id            String      @id @default(cuid())
  appointmentId String
  scheduledFor  DateTime
  sentAt        DateTime?
  status        String      @default("pending")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
}

model MedicalRecord {
  id           String   @id @default(cuid())
  patientId    String
  doctorId     String
  visitDate    DateTime
  diagnosis    String
  prescription String?
  notes        String?
  attachments  String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  doctor       User     @relation(fields: [doctorId], references: [id])
  patient      Patient  @relation(fields: [patientId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
}

model EmergencyAlert {
  id              String        @id @default(cuid())
  patientId       String
  clinicId        String
  emergencyType   EmergencyType
  details         String
  triggeredBy     String
  status          String        @default("ACTIVE")
  resolutionNotes String?
  resolvedAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  clinic          Clinic        @relation(fields: [clinicId], references: [id])
  patient         Patient       @relation(fields: [patientId], references: [id])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityId   String?
  entityType String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  compliance String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityId, entityType])
  @@index([createdAt])
}

model DoctorAvailability {
  id          String   @id @default(cuid())
  doctorId    String
  clinicId    String
  dayOfWeek   Int
  startTime   String
  endTime     String
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  clinic      Clinic   @relation(fields: [clinicId], references: [id])
  doctor      User     @relation(fields: [doctorId], references: [id])

  @@unique([doctorId, clinicId, dayOfWeek])
}

model Prescription {
  id           String    @id @default(cuid())
  patientId    String
  doctorId     String
  medication   String
  dosage       String
  frequency    String
  duration     String
  instructions String?
  startDate    DateTime
  endDate      DateTime?
  refills      Int       @default(0)
  status       String    @default("active")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  doctor       User      @relation(fields: [doctorId], references: [id])
  patient      Patient   @relation(fields: [patientId], references: [id])
}

model Billing {
  id            String       @id @default(cuid())
  patientId     String
  appointmentId String?      @unique
  amount        Float
  status        String       @default("pending")
  dueDate       DateTime
  paidDate      DateTime?
  paymentMethod String?
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  patient       Patient      @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([status])
}

model ClinicSetting {
  id          String   @id @default(cuid())
  clinicId    String
  key         String
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  clinic      Clinic   @relation(fields: [clinicId], references: [id])

  @@unique([clinicId, key])
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  PATIENT
  HMO_ADMIN
  RECEPTIONIST
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum EmergencyType {
  MEDICAL
  SECURITY
  SYSTEM
}
